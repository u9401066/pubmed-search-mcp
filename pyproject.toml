[build-system]
requires = ["hatchling"]
build-backend = "hatchling.build"

[project]
name = "pubmed-search-mcp"
version = "0.3.9"
description = "MCP server for PubMed literature search with MeSH, PICO, and intelligent query expansion"
readme = "README.md"
license = "Apache-2.0"
requires-python = ">=3.10"
authors = [
    { name = "u9401066", email = "u9401066@gap.kmu.edu.tw" }
]
keywords = [
    "pubmed",
    "entrez",
    "ncbi",
    "literature",
    "medical",
    "research",
    "search",
    "mcp",
    "model-context-protocol"
]
classifiers = [
    "Development Status :: 4 - Beta",
    "Intended Audience :: Developers",
    "Intended Audience :: Science/Research",
    "License :: OSI Approved :: Apache Software License",
    "Programming Language :: Python :: 3",
    "Programming Language :: Python :: 3.12",
    "Programming Language :: Python :: 3.13",
    "Topic :: Scientific/Engineering :: Medical Science Apps.",
    "Topic :: Scientific/Engineering :: Bio-Informatics",
]

dependencies = [
    "biopython>=1.81",
    "requests>=2.28.0",
    "pylatexenc>=2.10",  # Unicode to LaTeX conversion for BibTeX export
    "mcp>=1.0.0",  # MCP protocol - required for MCP server functionality
    "fastapi>=0.128.0",
    "httpx>=0.28.1",
    "tenacity>=8.0.0",
    "cachetools>=5.0.0",
    "pywin32>=311; sys_platform == 'win32'",
    "defusedxml>=0.7.1",
    "dependency-injector>=4.48.3",
    "pyyaml>=6.0",  # YAML pipeline config support
]

[project.scripts]
pubmed-search-mcp = "pubmed_search.presentation.mcp_server:main"

[project.urls]
Homepage = "https://github.com/u9401066/pubmed-search-mcp"
Repository = "https://github.com/u9401066/pubmed-search-mcp"
Issues = "https://github.com/u9401066/pubmed-search-mcp/issues"

[tool.hatch.build.targets.wheel]
packages = ["src/pubmed_search"]

[tool.hatch.build.targets.sdist]
include = [
    "/src",
    "/README.md",
    "/LICENSE",
]

[tool.pytest.ini_options]
testpaths = ["tests"]
python_files = ["test_*.py"]
asyncio_mode = "auto"
asyncio_default_fixture_loop_scope = "function"
# âš¡ MANDATORY: æ‰€æœ‰æ¸¬è©¦ä¸€å¾‹å¤šæ ¸åŸ·è¡Œ
# -n 8: é™åˆ¶ worker æ•¸é‡é¿å… OOMï¼ˆ32 logical cores Ã— ~1.5GB/worker > 48GB RAMï¼‰
# pytest-benchmark åœ¨ xdist æ¨¡å¼ä¸‹è‡ªå‹•åœç”¨ï¼ˆç„¡éœ€æ‰‹å‹•è™•ç†ï¼‰
# pytest-cov å®Œå…¨æ”¯æ´ xdistï¼ˆè‡ª pytest-cov 2.0+ï¼‰
addopts = "-n 4 --timeout=60"
markers = [
    "integration: marks tests as integration tests (may make real API calls)",
    "slow: marks tests as slow running",
]
filterwarnings = [
    "ignore::DeprecationWarning",
]

[tool.pytest-benchmark]
# Storage settings for baseline comparison
storage = "file://.benchmarks"
save = "0001"                 # auto-save with run number
compare = "0001"              # compare against baseline
min_rounds = 3
warmup = true
warmup_iterations = 1

[dependency-groups]
dev = [
    "deptry>=0.24.0",
    "mypy>=1.15",
    "pytest>=9.0",
    "pytest-asyncio>=0.26",
    "pytest-cov>=7.0",
    "ruff>=0.14,<0.15",
    "pytest-benchmark>=5.1.0",
    "mutmut>=3.2.0",
    "bandit>=1.8.0",
    "safety>=3.2.10",
    "pytest-timeout>=2.3.1",
    "vulture>=2.14",
    "types-requests>=2.32.4.20260107",
    "types-cachetools>=6.2.0",
    "types-PyYAML>=6.0",
    "pytest-xdist>=3.8.0",
    "pre-commit>=3.8",
    "semgrep>=1.151.0",
]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ruff â€” linter + formatter
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[tool.ruff]
target-version = "py310"
line-length = 120
src = ["src", "tests"]

[tool.ruff.lint]
# ğŸ”’ PRODUCTION: å•Ÿç”¨æ‰€æœ‰è¦å‰‡ï¼Œåƒ…æ’é™¤ä¸é©ç”¨çš„è¦å‰‡é›†
select = ["ALL"]
ignore = [
    # â”€â”€ formatter è² è²¬ â”€â”€
    "E501",    # line too long â€” handled by ruff format
    "W191",    # tab indentation â€” handled by formatter
    "COM812",  # missing trailing comma â€” conflicts with formatter
    "ISC001",  # implicit string concat in single line â€” conflicts with formatter
    "Q",       # quotes â€” handled by formatter

    # â”€â”€ ä¸é©ç”¨çš„è¦å‰‡é›† â”€â”€
    "D",       # pydocstyle â€” å•Ÿç”¨å¾Œå†é€æ­¥åŠ å…¥ï¼ˆTODO: Phase 2ï¼‰
    "ANN",     # flake8-annotations â€” ç”± mypy strict è² è²¬
    "FBT",     # boolean trap â€” å° API å±¤éæ–¼åš´æ ¼
    "FIX",     # fixme/todo â€” é–‹ç™¼éšæ®µå…è¨± TODO
    "TD",      # todo â€” é–‹ç™¼éšæ®µå…è¨± TODO
    "ERA",     # eradicate â€” èª¤åˆ¤ç‡é«˜ï¼ˆä¸­è‹±é›™èªè¨»è§£ï¼‰
    "CPY",     # copyright â€” ç”± LICENSE æª”æ¡ˆç®¡ç†
    "DJ",      # django â€” é Django å°ˆæ¡ˆ

    # â”€â”€ 3.10 ç›¸å®¹ â”€â”€
    "UP007",   # use X | Y union â€” needs 3.10+ runtime
    # UP038 removed in ruff 0.14 (integrated into UP007)

    # â”€â”€ ä¸­è‹±é›™èªå°ˆæ¡ˆ â”€â”€
    "RUF001",  # ambiguous unicode in string
    "RUF002",  # ambiguous unicode in docstring
    "RUF003",  # ambiguous unicode in comment

    # â”€â”€ ç‰¹å®šæ¨¡å¼è±å… â”€â”€
    "B008",    # function call in default arg â€” FastAPI/MCP Depends() pattern
    "B905",    # zip() without strict= â€” 3.10 compat
    "RUF012",  # mutable class var annotation â€” dataclass patterns
    "RUF022",  # __all__ not sorted â€” intentionally grouped by category
    "TRY003",  # long messages in exceptions â€” ä¸­æ–‡éŒ¯èª¤è¨Šæ¯éœ€è¦å®Œæ•´æè¿°
    "EM101",   # raw string in exception â€” ä¸­æ–‡éŒ¯èª¤è¨Šæ¯ç›´æ¥å¯«æ›´æ¸…æ¥š
    "EM102",   # f-string in exception â€” åŒä¸Š

    # â”€â”€ Logging é¢¨æ ¼ (production åˆç†é¸æ“‡) â”€â”€
    "G004",    # logging-f-string â€” ç¾ä»£ Python æ…£ä¾‹ï¼ŒMCP å–®ç”¨æˆ¶å ´æ™¯æ•ˆèƒ½å½±éŸ¿ <1Î¼s
    "TRY401",  # verbose-log-message â€” logging.exception(msg) å« context æ›´æ¸…æ¥š
    "TRY300",  # try-consider-else â€” é¢¨æ ¼åå¥½ï¼Œéå®‰å…¨å•é¡Œ

    # â”€â”€ æ¶æ§‹æ¨¡å¼ (MCP server ç‰¹æœ‰) â”€â”€
    "PLC0415", # import-outside-top-level â€” lazy import æ˜¯åˆ»æ„çš„å•Ÿå‹•æ•ˆèƒ½æœ€ä½³åŒ–
    "PLW0603", # global-statement â€” æ¨¡çµ„ç´š singleton/cache å¿…è¦æ¨¡å¼
    "PLR0913", # too-many-arguments â€” MCP tool function éœ€è¦å¤šåƒæ•¸ API surface
    "C901",    # complex-structure â€” éƒ¨åˆ†è§£æ/è·¯ç”±é‚è¼¯æœ¬è³ªè¤‡é›œï¼Œéœ€è¦å¤§è¦æ¨¡é‡æ§‹æ‰èƒ½é™ä½
    "PLR0912", # too-many-branches â€” åŒä¸Š
    "PLR0915", # too-many-statements â€” åŒä¸Š
    "PLR0911", # too-many-return-statements â€” early return æ˜¯å¥½å¯¦è¸

    # â”€â”€ API å®¢æˆ¶ç«¯æ¨¡å¼ â”€â”€
    "PERF401", # manual-list-comprehension â€” å¯è®€æ€§å„ªå…ˆï¼Œé hot path
    "PERF203", # try-except-in-loop â€” API æ‰¹æ¬¡è™•ç†éœ€è¦é€é …å®¹éŒ¯
]
fixable = ["ALL"]
unfixable = []

[tool.ruff.lint.isort]
known-first-party = ["pubmed_search"]

[tool.ruff.lint.per-file-ignores]
"tests/**/*.py" = [
    "S101",    # assert â€” pytest uses assert
    "S105",    # hardcoded password â€” test fixtures
    "S106",    # hardcoded password arg â€” test fixtures
    "S108",    # hardcoded temp file â€” test fixtures
    "S110",    # try-except-pass â€” test setup
    "S310",    # URL open â€” test HTTP calls
    "S311",    # pseudo-random â€” test data generation
    "B011",    # assert False
    "B017",    # assert blind exception
    "BLE001",  # blind exception â€” test error handling
    "PT",      # pytest style â€” existing tests may not follow
    "SIM",     # simplify â€” test readability
    "PLR2004", # magic value comparison â€” tests use literals
    "PLR0913", # too many arguments â€” test fixtures
    "ARG",     # unused arguments â€” pytest fixtures
    "RUF059",  # unused unpacked variable â€” test destructuring
    "B007",    # unused loop variable â€” test loops
    "RUF015",  # next(iter()) vs slice â€” test readability
    "SLF001",  # private member access â€” testing internals
    "T201",    # print â€” debug output in tests
    "N802",    # function name uppercase â€” test naming conventions
    "N803",    # argument name uppercase â€” test naming conventions
    "N806",    # variable name uppercase â€” mock naming conventions
    "INP001",  # implicit namespace package â€” tests dir
    "TRY",     # exception handling â€” test code can be simpler
    "EM",      # error message â€” test code can be simpler
    "PERF",    # performance â€” not critical in tests
    "C901",    # complexity â€” test functions can be complex
    "PLR0912", # too many branches â€” complex test scenarios
    "PLR0915", # too many statements â€” complex test setup
    "PTH",     # pathlib â€” test code uses os.path for simplicity
    "ASYNC",   # async â€” test code uses sync patterns (time.sleep, open)
    "PGH003",  # blanket-type-ignore â€” test type annotations
    "RET504",  # unnecessary-assign â€” test readability
    "S603",    # subprocess â€” test scripts
    "DTZ005",  # datetime-now â€” tests don't need tz
]
"scripts/**/*.py" = [
    "T20",     # print statements â€” expected in scripts
    "S603",    # subprocess call â€” scripts need it
    "S607",    # partial executable path â€” scripts intentional
    "B007",    # unused loop variable
    "BLE001",  # blind exception â€” script error handling
    "INP001",  # implicit namespace package â€” scripts dir
    "PLR0913", # too many arguments â€” script functions
    "PLR2004", # magic values â€” scripts use literals
    "SLF001",  # private member â€” FastMCP internal access
    "SIM102",  # nested-if â€” script readability
    "DTZ005",  # datetime-now â€” scripts don't need tz
    "ARG001",  # unused argument â€” script callbacks
    "PLW1510", # subprocess-run-without-check â€” scripts handle errors
    "PERF102", # dict-items â€” script readability
]
"run_copilot.py" = [
    "PTH",     # pathlib â€” sys.path manipulation
    "SLF001",  # private member â€” FastMCP internal access
    "PLR2004", # magic values â€” HTTP status codes
    "S104",    # bind-all â€” server intentional
    "INP001",  # namespace package
]
"run_server.py" = [
    "PTH",     # pathlib â€” sys.path manipulation
    "SLF001",  # private member â€” FastMCP internal access
    "S104",    # bind-all â€” server intentional
    "S108",    # hardcoded temp â€” export dir
    "N806",    # variable uppercase â€” EXPORT_DIR constant
    "SIM108",  # ternary â€” readability
    "ARG001",  # unused argument â€” Starlette request handlers
    "BLE001",  # blind exception â€” API error handling
    "TRY400",  # logging-error â€” contextual error messages
    "INP001",  # namespace package
]
"src/pubmed_search/infrastructure/**/*.py" = [
    "BLE001",  # blind-except â€” API å®¢æˆ¶ç«¯å¿…é ˆå®¹éŒ¯ä»»æ„å¤–éƒ¨éŒ¯èª¤
    "PLR2004", # magic-value â€” HTTP ç‹€æ…‹ç¢¼ (200, 404, 429) æ˜¯æ…£ä¾‹
    "ARG002",  # unused-method-argument â€” override/callback æ¨¡å¼
    "SLF001",  # private-member-access â€” æ¡†æ¶æ•´åˆéœ€å­˜å–å…§éƒ¨ç‹€æ…‹
    "A002",    # builtin-shadowing â€” `type`, `id`, `format` æ˜¯ API åƒæ•¸åç¨±
]
"src/pubmed_search/presentation/**/*.py" = [
    "BLE001",  # blind-except â€” MCP tool å¿…é ˆæ•ç²ä»»ä½•éŒ¯èª¤å›å‚³æœ‰æ„ç¾©çš„è¨Šæ¯
    "PLR2004", # magic-value â€” HTTP ç‹€æ…‹ç¢¼ã€é™åˆ¶å€¼
    "ARG001",  # unused-function-argument â€” MCP æ¡†æ¶è¦æ±‚çš„åƒæ•¸ç°½å
    "ARG002",  # unused-method-argument â€” åŒä¸Š
    "SLF001",  # private-member-access â€” FastMCP å…§éƒ¨ API æ•´åˆ
    "A002",    # builtin-shadowing â€” `type`, `id`, `format` æ˜¯ MCP tool åƒæ•¸
]
"src/pubmed_search/application/**/*.py" = [
    "BLE001",  # blind-except â€” session ç®¡ç†éœ€å®¹éŒ¯ I/O éŒ¯èª¤
    "PLR2004", # magic-value â€” è¨­å®šå¸¸æ•¸
    "ARG002",  # unused-method-argument â€” æŠ½è±¡æ–¹æ³•å¯¦ä½œ
]
".mutmut_config.py" = ["ALL"]  # auto-generated config
"vulture_whitelist.py" = ["ALL"]  # vulture whitelist uses bare name expressions
"scripts/test-copilot-mcp.py" = [
    "BLE001",  # blind exception â€” test script error handling
    "INP001",  # namespace package
]

[tool.ruff.format]
quote-style = "double"
indent-style = "space"
line-ending = "auto"

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# mypy â€” ğŸ”’ PRODUCTION strict mode
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[tool.mypy]
python_version = "3.10"
strict = true
# strict = true å•Ÿç”¨ä»¥ä¸‹æ‰€æœ‰åš´æ ¼æª¢æŸ¥ï¼š
#   disallow_any_generics, disallow_untyped_defs, disallow_incomplete_defs,
#   check_untyped_defs, no_implicit_optional, warn_redundant_casts,
#   warn_unused_ignores, warn_return_any, no_implicit_reexport,
#   strict_equality, strict_concatenate

# â”€â”€ é‡å°ç¬¬ä¸‰æ–¹åº«çš„å‹™å¯¦è±å… â”€â”€
ignore_missing_imports = true  # ç¬¬ä¸‰æ–¹åº«ç¼ºå°‘ py.typedï¼ˆé€æ­¥ç§»é™¤ï¼‰
warn_unused_ignores = false    # è·¨ Python ç‰ˆæœ¬çš„ type: ignore ç›¸å®¹æ€§
# æ¼¸é€²å¼åš´æ ¼åŒ–ï¼šä»¥ä¸‹æš«æ™‚æ”¾å¯¬ï¼Œå¾…é€æ­¥ä¿®å¾©å¾Œç§»é™¤
disallow_any_generics = false  # 94 errors â€” dict/list ç¼ºå°‘ type argsï¼ˆé€æ­¥åŠ å…¥ï¼‰

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Bandit â€” security linter (medium+ severity)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[tool.bandit]
# Only flag medium+ severity (skip low-noise rules)
skips = [
    "B404",   # import subprocess â€” tooling scripts need it
    "B603",   # subprocess without shell=True â€” scripts intentional
    "B311",   # pseudo-random â€” not crypto, used for jitter/test data
]
exclude_dirs = ["tests", "scripts/_tmp"]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Deptry â€” dependency hygiene
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
[tool.deptry]
extend_exclude = ["scripts", "tests", "docs"]

[tool.deptry.per_rule_ignores]
# DEP001 (missing): lazy optional imports â€” installed separately when needed
DEP001 = ["fitz", "pdfplumber"]
# DEP002 (unused): indirect usage (biopythonâ†’requests, platform-specific pywin32)
DEP002 = ["requests", "pywin32"]
# DEP003 (transitive): re-exports or direct usage of transitive deps
DEP003 = ["typing_extensions", "pydantic", "uvicorn"]

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Vulture â€” dead code detection (config reference; run via pre-commit)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Whitelist: vulture_whitelist.py
# Command: uv run vulture src/ scripts/ vulture_whitelist.py --min-confidence 80

[[tool.mypy.overrides]]
module = "tests.*"
ignore_errors = true

[[tool.mypy.overrides]]
module = [
    "pubmed_search.infrastructure.sources",
    "pubmed_search.infrastructure.sources.*",
]
# å¤–éƒ¨ API å›æ‡‰æœ¬è³ªä¸Šæ˜¯å‹•æ…‹çš„ (dict[str, Any])
disallow_untyped_defs = false
disallow_untyped_calls = false
warn_return_any = false
disable_error_code = ["no-untyped-def", "no-untyped-call", "no-any-return"]

[[tool.mypy.overrides]]
module = [
    "pubmed_search.infrastructure.ncbi",
    "pubmed_search.infrastructure.ncbi.*",
]
# NCBI API å›æ‡‰çµæ§‹è¤‡é›œä¸”å¤šè®Š
disallow_untyped_defs = false
disallow_untyped_calls = false
warn_return_any = false
disable_error_code = ["no-untyped-def", "no-untyped-call", "no-any-return"]

[[tool.mypy.overrides]]
module = [
    "pubmed_search.infrastructure.pubtator",
    "pubmed_search.infrastructure.pubtator.*",
]
# PubTator API å‹•æ…‹å›æ‡‰
disallow_untyped_defs = false
disallow_untyped_calls = false
warn_return_any = false
disable_error_code = ["no-untyped-def", "no-untyped-call", "no-any-return"]

[[tool.mypy.overrides]]
module = [
    "pubmed_search.presentation",
    "pubmed_search.presentation.*",
    "pubmed_search.presentation.api.*",
    "pubmed_search.presentation.mcp_server",
    "pubmed_search.presentation.mcp_server.*",
    "pubmed_search.presentation.mcp_server.tools.*",
]
# MCP tool/server å‡½æ•¸è™•ç†å‹•æ…‹æ•¸æ“š
disallow_untyped_defs = false
disallow_untyped_calls = false
warn_return_any = false
disable_error_code = ["no-untyped-def", "no-untyped-call", "no-any-return"]

[[tool.mypy.overrides]]
module = [
    "pubmed_search.application.session",
    "pubmed_search.application.session.*",
]
# Session ç®¡ç†æ¶‰åŠå¤§é‡å‹•æ…‹ JSON æ•¸æ“š
disallow_untyped_defs = false
disallow_untyped_calls = false
warn_return_any = false
disable_error_code = ["no-untyped-def", "no-untyped-call", "no-any-return"]
